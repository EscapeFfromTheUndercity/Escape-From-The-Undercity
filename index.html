<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Escape from the Undercity</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: monospace;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 40px;
    }
    h1 { font-size: 2.5rem; }
    nav { margin-top: 10px; }
    nav a { color: white; font-size: 1rem; margin: 0 10px; text-decoration: none; }
    nav a:hover { text-decoration: underline; }

    .subscribe {
      margin: 1.5rem auto; padding: 1rem; background-color: black;
      z-index: 2; position: relative;
    }
    .subscribe h3 { color: yellow; font-size: 1rem; margin-bottom: .6rem; }
    .subscribe input[type="email"] {
      padding: 5px; font-family: monospace; font-size: 1rem;
    }
    .subscribe button {
      padding: 5px 10px; background-color: #00aaff; border: none; color: black;
      font-family: monospace; font-size: 1rem; cursor: pointer;
    }

    @media (min-width: 600px) {
      nav a { font-size: 1.6rem; padding: 8px 14px; }
      .subscribe h3 { font-size: 1.6rem; }
      .subscribe input[type="email"] { font-size: 1.2rem; padding: 10px; width: 250px; }
      .subscribe button { font-size: 1.2rem; padding: 10px 16px; }
    }

    /* Pipes image */
    .smoke { display: block; margin: 0 auto; max-width: 100%; height: auto; }
    @media (min-width: 900px) {
      .smoke { max-height: 520px; }
    }

    /* Music toggle button */
    #musicToggle {
      position: fixed; left: 50%; bottom: 22px; transform: translateX(-50%);
      font-family: monospace; font-size: 1rem;
      background-color: #222; color: white; border: 1px solid #555;
      padding: 10px 18px; cursor: pointer; border-radius: 6px;
      z-index: 10;
    }

    /* Modal for Substack embed (keeps user on page) */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.7);
      display: none; align-items: center; justify-content: center;
      z-index: 20;
    }
    .modal {
      width: min(560px, 92vw);
      background: #111; border: 1px solid #333; border-radius: 10px;
      padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.6);
    }
    .modal header {
      padding-top: 0; margin-bottom: 8px;
    }
    .modal h4 { margin: 0; color: #ffd700; font-size: 1.1rem; }
    .modal .close {
      position: absolute; right: 14px; top: 10px;
      background: #222; color: #fff; border: 1px solid #555;
      border-radius: 6px; padding: 6px 10px; cursor: pointer;
    }
    iframe.substack-frame {
      width: 100%; height: 240px; border: 1px solid #333; background: #111;
    }
  </style>
</head>
<body>
  <header>
    <h1>Escape from the Undercity</h1>
    <nav>
      <a href="index.html">Home</a> |
      <a href="comic.html">Comic</a> |
      <a href="about.html">About</a> |
      <a href="shop.html">Shop</a>
    </nav>
  </header>

  <div class="subscribe">
    <h3>Join the Resistance</h3>
    <form id="substackForm" action="#" method="POST">
      <input type="email" id="emailInput" placeholder="Your email..." required autocomplete="email" aria-label="Email address">
      <button type="submit">Subscribe</button>
    </form>
  </div>

  <img src="Smoke.gif" alt="Rising smoke animation with chimneys" class="smoke" />

  <audio id="bgm" loop preload="auto">
    <source src="escape_main_theme_21aug25.ogg?v=2" type="audio/ogg">
    <source src="escape_main_theme_21aug25.mp3?v=2" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <button id="musicToggle" aria-pressed="true">ðŸ”Š Music: On</button>

  <!-- Modal with Substack embed so user never leaves site -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <button class="close" id="modalClose" aria-label="Close">Close âœ•</button>
      <header><h4 id="modalTitle">Subscribe</h4></header>
      <iframe class="substack-frame" id="substackFrame"
        src="about:blank" frameborder="0" scrolling="no" title="Substack Subscribe"></iframe>
      <p style="font-size:.9rem;color:#aaa;margin:.5rem 0 0;">
        A confirmation email will be sent after you subscribe.
      </p>
    </div>
  </div>

  <script>
    // Music toggle (unchanged)
    const audio = document.getElementById('bgm');
    const btn = document.getElementById('musicToggle');
    const pref = localStorage.getItem('bgmPref');

    function setButton(isOn) {
      btn.textContent = isOn ? 'ðŸ”Š Music: On' : 'ðŸ”‡ Music: Off';
      btn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
    }
    async function startIfAllowed() {
      if (pref === 'off') { setButton(false); return; }
      try { await audio.play(); setButton(true); localStorage.setItem('bgmPref', 'on'); }
      catch { setButton(false); }
    }
    btn.addEventListener('click', async () => {
      if (audio.paused) { try { await audio.play(); setButton(true); localStorage.setItem('bgmPref','on'); } catch {} }
      else { audio.pause(); setButton(false); localStorage.setItem('bgmPref','off'); }
    });
    document.addEventListener('DOMContentLoaded', startIfAllowed);

    // Substack modal logic
    const form = document.getElementById('substackForm');
    const emailInput = document.getElementById('emailInput');
    const backdrop = document.getElementById('modalBackdrop');
    const closeBtn = document.getElementById('modalClose');
    const frame = document.getElementById('substackFrame');

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      // Show modal and load Substack embed (keeps user on site)
      backdrop.style.display = 'flex';
      // Load Substack's official embed
      frame.src = 'https://escapefromtheundercity.substack.com/embed';
      // Note: We cannot programmatically prefill inside the iframe due to browser security (cross-origin).
      // User can enter their email in the embedded form without leaving the page.
    });
    closeBtn.addEventListener('click', () => {
      frame.src = 'about:blank';
      backdrop.style.display = 'none';
      emailInput.focus();
    });
    backdrop.addEventListener('click', (e) => {
      if (e.target === backdrop) { closeBtn.click(); }
    });
  </script>
</body>
</html>
